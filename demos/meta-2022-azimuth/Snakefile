include: "../common.smk"
configfile: "config.yml"

# https://twitter.com/satijalab/status/1404822000464433158

# cellxgene portal AWS URLs expire in one week.
# May need to get new URLs from https://cellxgene.cziscience.com/collections/2f75d249-1bec-459b-bf2b-b86221097ced

# Azimuth meta-analysis of 10 datasets of healthy and diseased human lung
H5AD_URL = "https://corpora-data-prod.s3.amazonaws.com/626d44f9-dec1-4ea6-9c0b-9cd59a245c53/local.h5ad?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIATLYQ5N5X7JY5SHKW%2F20221202%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20221202T132928Z&X-Amz-Expires=604800&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEIr%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQDB0XgKgEjlSUv7zrOvrgwFALkRY8dGG74X1GJ6EHGAzQIhAP17WELeX0fVjavU9Taovj2Dp51XeZGHFmlOqcTaVMOVKvQDCKP%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQARoMMjMxNDI2ODQ2NTc1Igzdp4V4CD0sQeVN1xYqyAO%2BH%2FzXvLvf5f%2BWYWXlQ13SxqwdE%2Fao1e0LCECqO6SDkyST2Du9qVtsjHlKJOcSJ2a07A%2BGossyvFSNPwTyyvZ0WtvQeLUJ0x6PIYnIOHYRvQveSxnRlFgsRpl2gvxxsyfhWuT1LzOQodqJvgkRF0CX%2F%2ByJOmIYo2q3Pk6jmLP%2BuKx325HxulX72n6o%2Fid2y9cSBhXHNj7HnfA5JoVNYq43KHnqfPGMBK%2FLoF3oMT3VYyy%2Fa3oUM0VI5PNtDn%2Bxbk%2BKELAQDhKqdCnqvdBo8mb7lDPFdisi4dp0ik1iHB%2BBI4F6qnOfd%2FofU%2B4BG%2BUUSrfYqpc5ZtF3Z6or3rv7iAOPx1Am8Frc%2BmRvFvOiwSW5%2Fd3OoZEFJxq7PchprikhYOU9AyjUWFpZwdpDLDi7e51Qwn8bYA4%2BjCRjg3NkOei4UFOMamM4Y44XV7QkZ3uCiwzkrgIGAyZf1G4Bt%2BcpQx6T6%2FtQIqTyGmcDxWjaAKFq3Da7f8i7DZYGBls2ivHMJEiGhsjS%2B3SLE6omq67uoFxZR2FYWGjwfqbpeMTwJmrHvlrRSEXtck2oID8WnqLnkmRnpZvSmheJzvMn53HyU2qPMH0IrzQYktwwrJennAY6pAG8w8FJ2ecmcwD1jxltTQw3GIQWprB5m0hN2rDYR1cmFy%2B8dFc8eFUz8h9JSt1CFr1BIzoEWV9UM%2BEG%2F%2BgSY7mpWPVlpcZ%2BnXVGSCDnw2f3f08D8Wt3Sw2zMUF38Bp6mzF3JLiR06hTmEJM%2F5QQqFzZZFnDL3ANHvwWDdAdng8wUBfkFlX9HkYJcgUFzVendzTHbFMzdhyVJuzDyWdqrkd4hsTKrg%3D%3D&X-Amz-Signature=85797ff46d9a6f891bf5c939d5832e4a1a0216cb646be4648d0b756f9a03ad32"

rule all:
    input:
        [ (PROCESSED_DIR / f) for f in config['output'] ]

rule convert_to_zarr:
    input:
        (RAW_DIR / "meta.h5ad")
    output:
        directory(PROCESSED_DIR / "meta_2022_azimuth.h5ad.zarr")
    params:
        script=(SRC_DIR / "convert_to_zarr.py")
    shell:
        '''
        python {params.script} \
            -i {input} \
            -o {output}
        '''

# Download raw h5ad file.
rule download_adata:
    output:
        (RAW_DIR / "meta.h5ad")
    params:
        file_url=H5AD_URL
    shell:
        '''
        curl -L --retry 999 --retry-delay 3 -C - -o {output} "{params.file_url}"
        '''
