include: "../common.smk"
configfile: "config.yml"

# cellxgene portal AWS URLs expire in one week.
# May need to get new URLs from https://cellxgene.cziscience.com/collections/c114c20f-1ef4-49a5-9c2e-d965787fb90c

# Survey of human embryonic development
H5AD_URL = "https://corpora-data-prod.s3.amazonaws.com/f8d5fda9-4508-4447-9ec0-4681ddccbf1e/local.h5ad?AWSAccessKeyId=ASIATLYQ5N5X6UMSV5FA&Signature=qNoUnShHBxyQx9Dszp7V9%2F0XZBc%3D&x-amz-security-token=IQoJb3JpZ2luX2VjEBMaCXVzLXdlc3QtMiJIMEYCIQC44jipNrKpGl0JcqaZmYFfqoEkMX86efFSqa%2FhytkOkAIhAN9d9KQi6jAP8vnYlNB8UIDOOZsFY9d1jlXmY4DYOCADKusDCEwQARoMMjMxNDI2ODQ2NTc1IgzGmGriNCMIGBwNcxQqyAPjChvtaaZBDUFZwPzQZSrYrs%2Fax1bMA3q%2Fgp%2Bye1wOXWPnCTp%2FpNQJ4WlxjFVm0cpTknGbNXszfU6pqazQ%2Bbxtrib%2BRscshjPU3rZAwvB1LSHSJlhyQoFdRkDr7eSU%2BJOTwv2eeMRTZXSju73ZmHKN9mOJ6k56RFCteIQjMPS8NqdBfq33Byjnywd%2F67a625jwXYMF7BqZvlEBgpKUhqKz1H%2BqFppxCjv3blvRb1sg92rjAa6N7AwprWP%2F9IlR%2BsSXNUkYzuIW%2F0SclrFwoC79M%2FQTRCvxZqOyCW85KSJENRSwDzv3mDx%2BeSEygljRMEGip%2FAdaWEpkr8uGHBR7%2FmxdGD1Mt4ANxGilN833a98OdLU0PPhTmQxNTTcx5WoRTCDhIcK4DqdRrX%2F%2Fg1uERnnOqZW4tOP3sz2ddIl94697W4wo5a9dkWxA%2FFrG2nGlG7zf4nhap4TK6YvrRG%2Fn%2Fbxl7LtvNAnLErFPr26mY7u6xdRr2rzYKGg0HAmRgPO6EVvCrmIrr9CCuhSVdgQXYmyHjKM6Pjygl8Hu6HrCSwlZrINY1nCLYU5zI7k%2FtnlrDCki0ftwoV5WvY1zsrFHBMFiHMuNr0zjkcwmIaVqgY6pAFdpIbHUKZun4gj%2FDujAsphUos2CD5Vm2Er54tW3KEAUWdn6n8405XG9blALPQ%2Fe3WGLeoC4gxbn8aib5RNv%2BX2uPt5dTz8Xe6bCsY9P4gcUFjrwd3h2rwkmt%2FXpJ08vyrVnErG%2Bb0t0HKSJJXmSLUEDp7eJpc71oRZt3ZUwXLli73PfLk7kKhxYDwO%2BmyS4Id3REyO9w0qPcjK%2BKxhs%2Bqd1PMvbA%3D%3D&Expires=1699646272"

rule all:
    input:
        [ (PROCESSED_DIR / f) for f in config['output'] ]

rule convert_to_zarr:
    input:
        (RAW_DIR / "cao.h5ad")
    output:
        directory(PROCESSED_DIR / "cao_2020_science.h5ad.zarr")
    params:
        script=(SRC_DIR / "convert_to_zarr.py")
    shell:
        '''
        python {params.script} \
            -i {input} \
            -o {output}
        '''

# Download raw h5ad file.
rule download_adata:
    output:
        (RAW_DIR / "cao.h5ad")
    params:
        file_url=H5AD_URL
    shell:
        '''
        curl -L --retry 999 --retry-delay 3 -C - -o {output} "{params.file_url}"
        '''
