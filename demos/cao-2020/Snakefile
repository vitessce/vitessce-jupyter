include: "../common.smk"
configfile: "config.yml"

# cellxgene portal AWS URLs expire in one week.
# May need to get new URLs from https://cellxgene.cziscience.com/collections/c114c20f-1ef4-49a5-9c2e-d965787fb90c

# Survey of human embryonic development
H5AD_URL = "https://corpora-data-prod.s3.amazonaws.com/f8d5fda9-4508-4447-9ec0-4681ddccbf1e/local.h5ad?AWSAccessKeyId=ASIATLYQ5N5X3W52YZOP&Signature=KPJEa5rqZpvGI6dm5CkyUyUqD24%3D&x-amz-security-token=IQoJb3JpZ2luX2VjEAwaCXVzLXdlc3QtMiJGMEQCID3aqxj1lYclMznxDCa%2Fs8XMKtQyGx92e5Ii09IKVgL4AiAdPbH9rgJ9KiDJqkM7OGmgQdI%2BpcYVX0Ik5YFur1a2sirrAwhFEAEaDDIzMTQyNjg0NjU3NSIMmKaHsQkVn5zuweAdKsgDJSIG4mGJtb2pcUpsV1AWNkApV1xqR%2FB7pzY8aQb%2Fl4JG%2Fbnqb1YJ7UCRfFdnfn0Si5I27LX3W90amLM5ol7lfUdKgd89ys255s%2FJ1c5uzZVl5qbHBXQV7lDSmECWIdYBHka7GcA1FbwMLWIPqd3b1nTMmkTgS8xmN8ebYrLbQkMxPlJ3E95f9%2BpF9s5oh0ci2mY6HJCeOz5x6PMKhfL0x47IO7BwGbimzi4wNSE0Uldf92GMvZkXDIYKRLgXrzh5ESxRv49WH%2FnxlGl6STRf7t%2BbR3afrr0nAmNbFD2j7gg8oU9ppXGmMxQLJ7KyCwN9c7P3KBj9PIKoP2%2FtfX%2BWsuqVe1nstjGcINLBLcuVaxSCCCmlXyrPAAzv3zdvjGCB%2Fr1NtdXCkgq3RttiQKJ35ikeAjRGjDbmgiacMRQ%2BIC2ycW6lijThQjAubJQXPCHD42IoGJPljSBIzQw32kLvMp4q7AxYg8VegikT4hqT4z5ploZAWvks%2FD6zPE0tMhRrOgzMTrBCmC6xAt3%2FDbbyRGZsbRW1%2FV7vfZfxzUFER6FBLSUYTaiD3uFD%2BvBWoBuy7iuKPkJF5gOF6JWIqwl4K1rJ3EGtqvfKMIHIk6oGOqYBYU8Xom5UMnj493PwCj%2Fc0JwUVbDjLzoDTownTlMFf1%2BcgXrZz%2BL1bBPQQOpu6sCQFpxtYPk1dAGdy%2BhZ9%2FNoF8MN0Th0%2BqLd9pxwzm9i4kWuIPj8kTHCbRAP91AhxP03xCMaNifOqS25%2FqRTHyDPxfiktfCF6d%2B5em05Y6BfsrL1imVxuXOQKR0nJbsiRuzvTJlVCj%2FIDpur%2BJa1JtrCtaim%2F2jHYQ%3D%3D&Expires=1699627391"

rule all:
    input:
        [ (PROCESSED_DIR / f) for f in config['output'] ]

rule convert_to_zarr:
    input:
        (RAW_DIR / "cao.h5ad")
    output:
        directory(PROCESSED_DIR / "cao_2020_science.h5ad.zarr")
    params:
        script=(SRC_DIR / "convert_to_zarr.py")
    shell:
        '''
        python {params.script} \
            -i {input} \
            -o {output}
        '''

# Download raw h5ad file.
rule download_adata:
    output:
        (RAW_DIR / "cao.h5ad")
    params:
        file_url=H5AD_URL
    shell:
        '''
        curl -L --retry 999 --retry-delay 3 -C - -o {output} "{params.file_url}"
        '''
