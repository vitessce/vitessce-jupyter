include: "../common.smk"
configfile: "config.yml"

# https://doi.org/10.1016/j.isci.2022.104097

# cellxgene portal AWS URLs expire in one week.
# May need to get new URLs from https://cellxgene.cziscience.com/collections/8e880741-bf9a-4c8e-9227-934204631d2a

# High Resolution Slide-seqV2 Spatial Transcriptomics Enables Discovery of Disease-Specific Cell Neighborhoods and Pathways

# Spatial transcriptomics in the healthy human kidney: Puck_200903_13
H5AD_URL = "https://corpora-data-prod.s3.amazonaws.com/c4bcefdb-6c4a-415e-95a4-eb73a41c734f/local.h5ad?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIATLYQ5N5XXB766BSD%2F20221203%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20221203T102622Z&X-Amz-Expires=604800&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEKH%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIAas8HGH6gFYQ10iGNNb32Y6hgBGmXhZxQJKembDoVZbAiEAqdwpBKkVyANzlpQJd43ebenc7A4%2BE5cCWMmaYag4%2BF4q9AMIuv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARABGgwyMzE0MjY4NDY1NzUiDLZ0X2m2X4yWoUoSqSrIA34ZLUIZxl9%2BjrohVJYf1cTKYlbMlefKiwtC%2FNbHybbL1ZKGjWJQDZb4MlwJG1wGh4P0PH%2F%2BrpVuCZ5hi8QQUHwNdPfUDpa89OKD0uVAMC9idEVEhKL%2Bw7idy0yMf%2BU5GvnYX%2F4wOmXVKN%2B6HNcK4od7nDktlCNp8%2F68EcG8jOw6SRHgVUYrOer3U5Ra0RKNTnw24lUk4XON2KR%2FQZgNSnCF1xG%2FuUUyOJOZ3OehIXVcyCtORbSCx4sUqT2HwlqACwcmTkP8UN0FzcY4Rpb6V3i0QyMOounbCGgTLB8IZJBdnxwDqVvkUIk4FzzDv9JINxt%2BxBvGOHKidfZ2yD1eePecKqWckJok39DogGpq57oQZ33ZPpVjRzjhX9iFe0J7EpTN2%2BQs21I1E99CykUUIQL5wpdeSE9EWYJh0muC049BQPznGKt33bHOUt5LNWBN0tfAPncuz%2Fh3V9YEdT9kJRLyS%2BcKOv4xyw%2BhcYJPFU4yfvu7HA%2FwsucgtwfcG80tCRHiWxuELJPlxO6x%2B%2BIpz0wM6a4u0BG74usNdWzPrjNjfeCaqQK1WLZS9alPAKT6IL9Ru%2FccainOTfM4auDBzeWmwy3Vx4eT4DD9lKycBjqlAQPXoIfnBvt4kAcN1U7irrywm%2Fa42zsj4RGLokem4ChgP1NlDNygpQMjdp4w8A%2FNXMfn24I8t57DV1OJ09CH8JrU0sECPdurULL%2F8EQiLUcjLKvcpj4DZyZ1gCOT43IR7QPVcnadS8%2Bd5mWE%2Fhvaked0F9m6ds14TEgH9FUTqn9c97fT6627wz1uAX3SEZMW3j6GY1lkpHjQAGLlt4qxLZ6MwfGlHg%3D%3D&X-Amz-Signature=ba5c82d32cc44b1ca58d5533d528b6f8e0d7291988eef9af7e6f463a5d8d8657"

rule all:
    input:
        [ (PROCESSED_DIR / f) for f in config['output'] ]

rule convert_to_zarr:
    input:
        (RAW_DIR / "marshall_2022_iscience.h5ad")
    output:
        directory(PROCESSED_DIR / "marshall_2022_iscience.h5ad.zarr")
    params:
        script=(SRC_DIR / "convert_to_zarr.py")
    shell:
        '''
        python {params.script} \
            -i {input} \
            -o {output}
        '''

# Download raw h5ad file.
rule download_adata:
    output:
        (RAW_DIR / "marshall_2022_iscience.h5ad")
    params:
        file_url=H5AD_URL
    shell:
        '''
        curl -L -o {output} "{params.file_url}"
        '''